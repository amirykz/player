import React, { useState, useMemo } from "react";

export default function WireDrawingCalculator() {
  const [d0, setD0] = useState(1.38);
  const [df, setDf] = useState(0.2);
  const [n, setN] = useState(20);
  const [precision, setPrecision] = useState(5);
  const [useAnnealer, setUseAnnealer] = useState(false);
  const [annealTemp, setAnnealTemp] = useState(450); // پیش‌فرض دمای آنیل (°C)

  const rows = useMemo(() => {
    const r = [];
    if (d0 <= 0 || df <= 0 || n <= 0) return r;
    const ratio = Math.pow(df / d0, 1 / n);
    let d_in = d0;
    for (let i = 1; i <= n; i++) {
      const d_out = d_in * ratio;
      const A_in = Math.PI * Math.pow(d_in, 2) / 4;
      const A_out = Math.PI * Math.pow(d_out, 2) / 4;
      const percArea = (1 - A_out / A_in) * 100;
      const percDiam = (1 - d_out / d_in) * 100;
      r.push({
        i,
        d_in: Number(d_in.toFixed(precision)),
        d_out: Number(d_out.toFixed(precision)),
        A_in: Number(A_in.toFixed( precision )),
        A_out: Number(A_out.toFixed( precision )),
        percArea: Number(percArea.toFixed(3)),
        percDiam: Number(percDiam.toFixed(3)),
      });
      d_in = d_out;
    }
    return r;
  }, [d0, df, n, precision]);

  function downloadCSV() {
    const header = [
      "شماره قالب",
      "قطر ورودی (mm)",
      "قطر خروجی (mm)",
      "مساحت ورودی (mm^2)",
      "مساحت خروجی (mm^2)",
      "کاهش سطح (%)",
      "کاهش قطر (%)",
    ];
    const lines = [header.join(",")];
    rows.forEach(r => {
      lines.push([
        r.i,
        r.d_in,
        r.d_out,
        r.A_in,
        r.A_out,
        r.percArea,
        r.percDiam,
      ].join(","));
    });
    if (useAnnealer) {
      lines.push("\n*** Annealer Active: دمای آنیل = " + annealTemp + " °C ***");
    }
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `wire-drawing-${d0}-to-${df}-${n}-dies.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  return (
    <div className="p-6 max-w-4xl mx-auto">
      <h1 className="text-2xl font-semibold mb-4">محاسبه‌گر قالب کشش مفتول</h1>
      <p className="mb-4 text-sm text-muted-foreground">فرمول پایه: d_i = d0 * (df/d0)^(i/n)</p>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
        <label className="flex flex-col">
          <span className="text-sm">قطر ورودی (mm)</span>
          <input className="p-2 rounded border" type="number" step="0.0001" value={d0} onChange={e => setD0(Number(e.target.value))} />
        </label>
        <label className="flex flex-col">
          <span className="text-sm">قطر نهایی (mm)</span>
          <input className="p-2 rounded border" type="number" step="0.0001" value={df} onChange={e => setDf(Number(e.target.value))} />
        </label>
        <label className="flex flex-col">
          <span className="text-sm">تعداد قالب‌ها</span>
          <input className="p-2 rounded border" type="number" min={1} value={n} onChange={e => setN(Number(e.target.value))} />
        </label>
      </div>

      <div className="flex flex-col md:flex-row gap-3 mb-4">
        <label className="flex items-center gap-2">
          <input type="checkbox" checked={useAnnealer} onChange={e => setUseAnnealer(e.target.checked)} />
          <span className="text-sm">استفاده از آنیلر (Annealer)</span>
        </label>
        {useAnnealer && (
          <label className="flex items-center gap-2">
            <span className="text-sm">دمای آنیل (°C)</span>
            <input type="number" className="w-20 p-1 rounded border" value={annealTemp} onChange={e => setAnnealTemp(Number(e.target.value))} />
          </label>
        )}
      </div>

      <div className="flex gap-2 items-center mb-4">
        <label className="flex items-center gap-2">
          <span className="text-sm">دقت اعشار</span>
          <input type="number" min={0} max={8} value={precision} onChange={e => setPrecision(Number(e.target.value))} className="w-16 p-1 rounded border" />
        </label>
        <button onClick={downloadCSV} className="ml-auto px-3 py-2 rounded bg-slate-800 text-white">دانلود CSV</button>
      </div>

      <div className="overflow-x-auto rounded border">
        <table className="min-w-full text-sm table-auto">
          <thead className="bg-gray-50">
            <tr>
              <th className="p-2">#</th>
              <th className="p-2">قطر ورودی (mm)</th>
              <th className="p-2">قطر خروجی (mm)</th>
              <th className="p-2">مساحت ورودی (mm²)</th>
              <th className="p-2">مساحت خروجی (mm²)</th>
              <th className="p-2">کاهش سطح (%)</th>
              <th className="p-2">کاهش قطر (%)</th>
            </tr>
          </thead>
          <tbody>
            {rows.map(r => (
              <tr key={r.i} className="odd:bg-white even:bg-gray-50">
                <td className="p-2">{r.i}</td>
                <td className="p-2">{r.d_in}</td>
                <td className="p-2">{r.d_out}</td>
                <td className="p-2">{r.A_in}</td>
                <td className="p-2">{r.A_out}</td>
                <td className="p-2">{r.percArea}</td>
                <td className="p-2">{r.percDiam}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {useAnnealer && (
        <div className="mt-4 p-3 rounded bg-yellow-50 border text-sm text-yellow-800">
          <p>⚡ آنیلر فعال است: دمای تنظیم شده {annealTemp} °C</p>
        </div>
      )}

      <div className="mt-4 text-sm text-gray-700">
        <p>نکات: درصد کاهش نمایش داده شده مربوط به هر مرحله است؛ اگر مقداری بیش از حدود معمول (>25%) مشاهده شد، تعداد قالب را افزایش دهید یا یک مرحله میانی اضافه کنید.</p>
      </div>
    </div>
  );
}
